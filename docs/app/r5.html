<html>
  <head>
    <title>Ancient Temple of Ocypress</title>
    <style>
body {
  margin: 0px;
}
      
.image-container {
  position: relative;
  width: 1000px;
  height: 660px;
  display: flex;
  justify-content: center;
  margin: auto;
  overflow: hidden;
}

.fullImage {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 1000px;
  padding: 0px;
  margin: 0px;
  border: none;
  object-fit: cover;
}

#sun {
  z-index: -101;
  height: 563px;
}

.sunrise {
  animation-name: sunrise;
  animation-duration: 3500ms;
  animation-delay: 2250ms;
  animation-iteration-count: 1;
  animation-timing-function: ease-in-out;
  animation-direction: normal;
  animation-fill-mode: forwards;
  animation-play-state: running;
  transform-origin: 0% 100%;
}

@keyframes sunrise {
  100% { top: -120; rotate: -8deg}
}

.backgroundImage {
  z-index: -99;
  opacity: 0;
}

#firmament {
  z-index: -98;
  height: 563px;
}

.skyfall {
  animation-name: fadeAway;
  animation-duration: 3000ms;
  animation-delay: 250ms;
  animation-iteration-count: 1;
  animation-timing-function: ease-in;
  animation-direction: normal;
  animation-fill-mode: forwards;
  animation-play-state: running;
}

@keyframes fadeAway {
  100% { opacity: 0; }
}

.foregroundImage {
  z-index: 2;
}

.blocks {
  top: 200px;
  left: 390px;
  height: 400px;
  position: absolute;
  list-style-type: none;
  cursor: pointer;
}

.block {
  position: absolute;
}

.newBlock {
  animation-duration: 400ms;
  animation-name: blockAppears;
  animation-composition: add;
}

@keyframes blockAppears {
  0% { top: -1000px; }
  100% { top: 0px; }
}

.removeBlock {
  animation-duration: 800ms;
  animation-name: blockDisappears;
  animation-composition: add;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
}

@keyframes blockDisappears {
  0% { top: 0px; }
  20% { top: -80px; scale: 0.8; left: -8; }
  21% { z-index: -70; }
  100% { top: 400px; scale: 0.5; z-index: -70; left: -40; }
}

/* button.door {
  cursor: pointer;
  position: absolute;
  z-index: 2;
  left: 476px;
  top: 129px;
  height: 13px;
  width: 51px;
  background-color:  whitesmoke;
  border-style: none;
  border-radius: 10px;
  box-shadow: 0px 0px 10px 10px wheat;
  opacity: 0%;
  animation-name: fadeIn90;
  animation-duration: 1s;
  animation-delay: 100ms;
  animation-iteration-count: 1;
  animation-timing-function: linear;
  animation-direction: normal;
  animation-fill-mode: forwards;
  animation-play-state: running;
  transform-origin: center;
} */

    </style>

    <script language="javascript">
      // TODO: *** Human protection ***- check wrongClicks == 0 + hover
      // TODO Resize images

      function reveal() {
        const sky = document.querySelector('#firmament');
        sky.classList.add('skyfall');

        const sun = document.querySelector('#sun');
        sun.classList.add('sunrise');
      }

      // function showPortalButton() {
      //   const container = document.querySelector('.image-container');
      //   const button = document.createElement('button');
      //   button.classList.add('door');
      //   container.appendChild(button);
      //   button.addEventListener('click', openDoor);
      // }

      function showTemple() {
        // Only show temple when everything else is loaded to there is no spoiler
        const temple = document.querySelector('.backgroundImage');
        temple.style.opacity = 1;
      }

      function loaded() { 
        showTemple();

        const minBlocks = 4;
        const maxBlocks = 7;
        const numberOfBlocks = randomBetween(minBlocks, maxBlocks);
        addBlocks(numberOfBlocks);
      }

      function randomBetween(min, max) {
        const diff = max - min;
        const delta = Math.round(Math.random() * diff);
        return min + delta;
      }

      let lastBlock = null;

      function addBlocks(numberOfBlocks) {
        const list = document.querySelector('.blocks');
        const bottom = 390;
        const height = 55;
        const overlap = 12;
        const msdelay = 300;
        for (i=0; i < numberOfBlocks; i++) {
          const top = bottom - ((i+1) * (height-overlap));
          const zorder = 50 + i;
          const offset = randomBetween(-20, 20);
          setTimeout(() => { 
            lastBlock = addBlock(list, top, height, zorder, offset, lastBlock);
          }, msdelay * i);
        }
      }

      function addBlock(list, top, height, zorder, hoffset, previousBlock) {
        const img = document.createElement('img');
        img.src = 'img/block.png'
        img.alt = 'block';
        img.style.width = 200;
        img.style.height = height;
        
        const block = document.createElement('li');
        block.appendChild(img);
        block.style.top = top;
        block.style.height = height;
        block.style.zIndex = zorder;
        block.style.left = hoffset;
        block.classList.add('block');
        block.classList.add('newBlock');
        block.addEventListener('click', clickBlock);
        
        if (previousBlock) {
          list.insertBefore(block, previousBlock);
        } else {
          list.appendChild(block);
        }

        return block;
      }

      let wrongClicks = 0;

      function clickBlock(event) {
        if (event.target.tagName.toUpperCase() == 'LI') {
          tryToRemoveBlock(event.target);
        }

        if (event.target.tagName.toUpperCase() == 'IMG') {
          if (event.target.parentElement.tagName.toUpperCase() == 'LI') {
            tryToRemoveBlock(event.target.parentElement)
          }
        }
      }

      function tryToRemoveBlock(block) {
        const index = Array.prototype.indexOf.call(block.parentNode.children, block);
        if (index == 0) { 
          removeBlock(block);
        } else {
          wrongClicks++;
        }
      }

      function removeBlock(block) {
        block.classList.remove('newBlock');
        block.classList.add('removeBlock');
        block.addEventListener("animationend", () => deleteBlock(block));
      }

      function deleteBlock(block) {
        const countBeforeDelete = block.parentNode.childElementCount;
        block.parentNode.removeChild(block);
        if (countBeforeDelete == 1) { 
          // Last block was removed
          reveal();
        }
      }

      let hoverTempleCount = 0;
      function hoverTemple() {
        hoverTempleCount++;
      }

      function openDoor(event) {
        if (isHuman() || wrongClicks > 0) {
          window.alert('Looks like this is they way through, but we need to send something smaller.');
        } else {
          window.alert('Entering the ancient temple');
        }
      }

      function isHuman() {
        return hoverTempleCount > 3 || !isCypressRunning();
      }

      function isCypressRunning() {
        return window.Cypress;
      }

    </script>
  </head>

  <body onload="loaded();">

    <div class="image-container">
      <!-- TODO Merge sky into background when the game size is decided, and remove this separate element -->
      <img
        id="sun"
        src="img/r3-sky.png"
        alt="Blue sky with sun"
        class="fullImage"
      />

      <img
        src="img/r3-background.png"
        alt="Temple"
        class="fullImage backgroundImage"
      />

      <img
        id="firmament"
        src="img/r3-sky.png"
        alt="Blue sky with sun"
        class="fullImage"
      />

      <img
        src="img/r3-foreground.png"
        alt="Temple courtyard"
        class="fullImage foregroundImage"
      />

      <ol class="blocks">

      </ol>
      
    </div>
  </body>
</html>
