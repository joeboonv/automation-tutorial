<html>
  <head>
    <title>Ancient Temple of Ocypress</title>
    <style>
body {
  margin: 0px;
}

.image-container {
  position: relative;
  width: 1000px;
  height: 660px;
  display: flex;
  justify-content: center;
  margin: auto;
  overflow: hidden;
}

.fullImage {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 1000px;
  padding: 0px;
  margin: 0px;
  border: none;
}

.backgroundImage {
  z-index: -99;
}

.behindForeground {
  z-index: 1;
  position: absolute;
  object-fit: contain;
}

.layer1 {
  z-index: 3;
  position: absolute;
  object-fit: contain;
}

.layer2 {
  z-index: 4;
  position: absolute;
  object-fit: contain;
}

.large-pedestal {
  left: 710px;
  top: 430px;
  height: 200px;
}

.pot-3 {
  left: 694px;
  top: 304px;
  width: 145px;
}

.column {
  left: 180px;
  top: 400px;
  height: 220px;
  transform-origin: 50% 90%;
  rotate: 0deg;
  animation-name: wobble;
  animation-duration: 200ms;
  animation-delay: 1s;
  animation-iteration-count: 3;
  animation-timing-function: linear;
  animation-direction: normal;
  animation-fill-mode: forwards;
  animation-play-state: running;
}

.key {
  position: absolute;
  left: 190px;
  top: 550px;
  object-fit: contain;
  width: 100px;
}

svg {
  position: absolute;
  left: 0px;
  top: 0px;
}

@keyframes wobble {
  0%   { rotate: 0deg; top: 400px }
  25%  { rotate: 2deg; top: 399px }
  50%  { rotate: 0deg; top: 400px }
  75%  { rotate: -2deg; top: 399px }
  100% { rotate: 0deg; top: 400px }
}

.fallingColumn {
  left: 380px;
  top: 350px;
  height: 220px;
  transform-origin: 50% 90%;
  rotate: 0deg;
  animation-name: fall;
  animation-duration: 2100ms;
  animation-delay: 250ms;
  animation-iteration-count: 1;
  animation-timing-function: cubic-bezier(.41,.25,1,-0.02);
  animation-direction: normal;
  animation-fill-mode: forwards;
  animation-play-state: running;
}

@keyframes fall {
  0%   { rotate: 0deg }
  93% { rotate: 95deg; top: 310px; left: 400px; }
  96% { rotate: 90deg; top: 310px; left: 400px; }
  100% { rotate: 95deg; top: 310px; left: 400px; }
}

.swayingColumn {
  left: 380px;
  top: 350px;
  height: 220px;
  transform-origin: 50% 90%;
  rotate: 0deg;
  animation-name: swayRight, swayAcross, swayAcross, swayAcross, swayCentre;
  animation-duration: 900ms, 1000ms, 800ms, 400ms, 250ms;
  animation-delay: 100ms, 1000ms, 3000ms, 4600ms, 5400ms;
  animation-iteration-count: 1, 2, 2, 2, 1;
  animation-direction: normal, alternate, alternate, alternate, normal;
  animation-fill-mode: forwards, forwards, forwards, forwards, forwards;
  animation-play-state: running, running, running, running, running;
}

/* This is very useful: https://cubic-bezier.com/ */

@keyframes swayRight {
  0% { rotate: 0deg; top: 350px; left: 380px; animation-timing-function: cubic-bezier(0,.5,.62,1) }
  100% { rotate: 20deg; top: 340px; left: 382px; }
}

@keyframes swayAcross {
  0% { rotate: 20deg; top: 340px; left: 382px; animation-timing-function: cubic-bezier(.5,0,1,.62) }
  50% { rotate: 0deg; top: 350px; left: 380px; animation-timing-function: cubic-bezier(0,.5,.62,1) }
  100% { rotate: -20deg; top: 340px; left: 378px;  }
}

@keyframes swayCentre {
  0% { rotate: 20deg; top: 340px; left: 382px; animation-timing-function: cubic-bezier(.74,.44,1,1.36) }
  100% { rotate: 0deg; top: 350px; left: 380px; }
}

    </style>
    <!-- TODO remove one at a time and see which we don't need -->
    <!-- <script src="https://d3js.org/d3-dispatch@3"></script>
    <script src="https://d3js.org/d3-quadtree@3"></script>
    <script src="https://d3js.org/d3-timer@3"></script>
    <script src="https://d3js.org/d3-force@3"></script>
    <script src="https://d3js.org/d3-selection@3"></script>
    <script src="https://d3js.org/d3-shape@3"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>  
    <script src="https://d3js.org/d3-color.v1.min.js"></script>  
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>  
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>  
     -->
  </head>


    
    <script type="module" lang="javascript">

import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";


      // open pages
      // rope
      // https://codepen.io/keetraxx/pen/oNzXKVN?editors=0010
      // https://github.com/d3
      //
      // drag
      // https://anseki.github.io/plain-draggable/
      // https://www.w3schools.com/html/tryit.asp?filename=tryhtml5_draganddrop
      // https://www.w3schools.com/html/tryit.asp?filename=tryhtml5_draganddrop2
      // https://www.w3schools.com/html/html5_draganddrop.asp
      // 
      
      
      
      
      
      
      
      // TODO use https://www.flickr.com/photos/krishnacolor/37892625552 ? 
      // TODO use https://en.wikipedia.org/wiki/File:Preceptory_Tower_interior_(geograph_3578331).jpg ?
      // DRAG ball and release
      
      
      
      
      
      
      // How many simulation points a cable will have, more will take up more resources
      const CABLE_SEGMENTS = 5;
      
      // Append an SVG element
      const svg = d3.select("body")
        .append("svg")
        .attr("width", 1000)
        .attr("height", 660);
//      svg.append('text').attr('y', 20).text('Click and drag to create a cable')
      
      // Save reference to the last added cable
      let cable;
      
      // Draws a line out of the simulation points
      const simulationNodeDrawer = d3
        .line()
        .x((d) => d.x)
        .y((d) => d.y)
        .curve(d3.curveBasis);
      
      let i = 0;
      
      d3.select(document)
        .on("mousedown", (mouseEvent) => {
      
          // Start a new cable
          let c = svg.append("path").attr("stroke", d3.schemeCategory10[i % 10]);
          cable = c;
          // Create the nodes: o  o  o  o  o
          const nodes = d3.range(CABLE_SEGMENTS).map(() => ({}));
        
          // Link the nodes:  o-->o-->o-->o-->o
          const links = d3
            .pairs(nodes)
            .map(([source, target]) => ({ source, target }));
        
          // fix the position of the first node where you clicked
          nodes[0].fx = mouseEvent.clientX;
          nodes[0].fy = mouseEvent.clientY;
      
          // use a force simulation to simulate the cable
          const sim = d3
            .forceSimulation(nodes)
            .force("gravity", d3.forceY(2000).strength(0.005)) // simulate gravity
            .force("collide", d3.forceCollide(20)) // simulate cable auto disentanglement (cable nodes will push each other away)
            .force("links", d3.forceLink(links).strength(0.9)) // string the cables nodes together
            .on("tick", () => c.attr("d", (d) => simulationNodeDrawer(d.nodes))); // draw the path on each simulation tick
        
          // each cable has its own nodes and simulation
          cable.datum({ nodes, sim });
          i++;
        })
      
        .on("mousemove", (mouseEvent) => {
          if (cable) {
            const { nodes, sim } = cable.datum();
            const start = nodes[0];
            const end = nodes[nodes.length - 1];
            
            // set new position of the end of the cable
            end.fx = mouseEvent.clientX;
            end.fy = mouseEvent.clientY;
            
            // measure distance
            const distance = Math.sqrt(
              Math.pow(end.fx - start.fx, 2) + Math.pow(end.fy - start.fy, 2)
            );
            
            // set the link distance
            sim.force("links").distance(distance / CABLE_SEGMENTS);
            sim.alpha(1);
            sim.restart();
          }
        })
        .on("mouseup", () => (cable = undefined));
      
      
      </script>

      <script lang="javascript">
      
      
      
      
            // TODO Resize images
      
            function fall() {
              changeColumnClass('fallingColumn');
            }
            
            function sway() {
              changeColumnClass('swayingColumn');
            }
      
            // TODO Switch back to 'column' class after the animation completes, pr remove all classes and just set the attribute
            function changeColumnClass(newClass) {
              const column = document.querySelector('.column');
              column.classList.remove('column');
              column.classList.add(newClass);
            }
      
            function showPortalButton() {
              const container = document.querySelector('.image-container');
              const button = document.createElement('button');
              button.classList.add('door');
              container.appendChild(button);
              button.addEventListener('click', openDoor);
            }
      
            let hoverTempleCount = 0;
            function hoverTemple() {
              hoverTempleCount++;
            }
      
            function openDoor(event) {
              if (isHuman()) {
                window.alert('Looks like this is they way through, but we need to send something smaller.');
              } else {
                window.alert('Entering the ancient temple');
              }
            }
      
            function isHuman() {
              return hoverTempleCount > 3 || !isCypressRunning();
            }
      
            function isCypressRunning() {
              return window.Cypress;
            }
      
          </script>
            <body onload="loaded();">


    <div class="image-container">

      <img
        src="img/r4-background.png"
        alt="Temple"
        class="fullImage backgroundImage"
      />

      <img
        src="img/key.png"
        alt="Old key"
        class="key"
      />

      <img
        src="img/r4-column.png"
        alt="Large stone column"
        class="behindForeground column"
      />

      <img
        src="img/r3-large-pedestal.png"
        alt="Large stone pedestal"
        class="layer1 large-pedestal"
        onclick="sway();"
      />

      <img
        src="img/r3-pot.png"
        alt="Clay pot on top of a large pedestal"
        class="layer2 pot-3"
        onclick="fall();"
      />
      
    </div>
  </body>
</html>
