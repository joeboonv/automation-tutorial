<html>
  <head>
    <title>Ancient Temple of Ocypress</title>
    <style>
body {
  margin: 0px;
}
      
.image-container {
  position: relative;
  width: 1000px;
  height: 660px;
  display: flex;
  justify-content: center;
  margin: auto;
  overflow: hidden;
}

.fullImage {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 1000px;
  padding: 0px;
  margin: 0px;
  border: none;
  object-fit: cover;
}

.backgroundImage {
  z-index: -99;
}

#waterLevel {
  width: 1200px;
  left: -100px;
  top: 661px;
  height: 190px;
  position: absolute;
  overflow: hidden;
}

#water {
  opacity: 30%;
  width: 1200px;
  left: 0px;
  top: 20px;
  position: absolute;
}

.fill-water {
  animation-name: fill-water;
  animation-duration: 4s;
  animation-delay: 10ms;
  animation-timing-function: ease-in-out;
  animation-fill-mode: forwards;
}

@keyframes fill-water {
  0% { top: 661px; }
  100% { top: 470px; }
}

.slosh-water {
  animation-name: slosh-water;
  animation-duration: 12s;
  animation-delay: 10ms;
  animation-timing-function: ease-in-out;
  animation-fill-mode: forwards;
  animation-iteration-count: infinite;
  animation-direction: alternate;
  animation-composition: add;
}

@keyframes slosh-water {
  0% { top: 0px; opacity: 0%; rotate: 0deg; }
  25% { rotate: 1deg; }
  50% { rotate: 0deg; }
  75% { rotate: -1deg; }
  100% { top: 20px; opacity: -10%; rotate: 0deg; }
}

.drain-water {
  top: 470px;
  animation-name: drain-water;
  animation-duration: 4s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
}

@keyframes drain-water {
  0% { top: 470px; }
  30% { top: 470px; }
  100% { top: 661px; }
}

.drain-water-fail {
  top: 470px;
  animation-name: drain-water-fail;
  animation-duration: 3s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
}

@keyframes drain-water-fail {
  0% { top: 470px; }
  100% { top: 510px; }
}

.zoomBackground {
  animation-name: zoom;
  transform-origin: 50% 48%;
  animation-duration: 2s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
}

@keyframes zoom {
  0% { scale: 1.0; opacity: 1.0; }
  100% { scale: 5.0; opacity: 0.2; }
}

.layer1 {
  z-index: 3;
  position: absolute;
  object-fit: contain;
}

.layer2 {
  z-index: 4;
  position: absolute;
  object-fit: contain;
}

.layer3 {
  z-index: 5;
  position: absolute;
  object-fit: contain;
}

.layer4 {
  z-index: 6;
  position: absolute;
  object-fit: contain;
}

.gear-c {
  left: 215px;
  top: 230px;
  height: 60px;
  rotate: 40deg;
}

.rotate-gear-c {
  animation-name: rotate-gear-c;
  animation-duration: 4s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes rotate-gear-c {
  0% { rotate: 40deg }
  100% { rotate: -80deg }
}

.rotate-gear-c-fail {
  animation-name: rotate-gear-c-fail;
  animation-duration: 3s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes rotate-gear-c-fail {
  0% { rotate: 40deg }
  90% { rotate: -20deg }
  100% { rotate: 280deg }
}

.gear-abc {
  left: 470px;
  top: 130px;
  height: 60px;
  rotate: 60deg;
}

.rotate-gear-abc {
  animation-name: rotate-gear-abc;
  animation-duration: 4s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes rotate-gear-abc {
  0% { rotate: 60deg }
  100% { rotate: -60deg }
}

.rotate-gear-abc-fail {
  animation-name: rotate-gear-abc-fail;
  animation-duration: 3s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes rotate-gear-abc-fail {
  0% { rotate: 60deg }
  90% { rotate: 0deg }
  100% { rotate: 160deg }
}

.gear-ab {
  left: 700px;
  top: 230px;
  height: 60px;
  rotate: 80deg;
}

.rotate-gear-ab {
  animation-name: rotate-gear-ab;
  animation-duration: 4s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes rotate-gear-ab {
  0% { rotate: 80deg }
  100% { rotate: -40deg }
}

.rotate-gear-ab-fail {
  animation-name: rotate-gear-ab-fail;
  animation-duration: 3s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes rotate-gear-ab-fail {
  0% { rotate: 80deg }
  90% { rotate: 20deg }
  100% { rotate: 120deg }
}

.gear-a {
  left: 600px;
  top: 365px;
  height: 60px;
  rotate: 0deg;
}

.rotate-gear-a {
  animation-name: rotate-gear-a;
  animation-duration: 4s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes rotate-gear-a {
  0% { rotate: 0deg }
  100% { rotate: 85deg }
}

.rotate-gear-a-fail {
  animation-name: rotate-gear-a-fail;
  animation-duration: 3s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes rotate-gear-a-fail {
  0% { rotate: 0deg }
  90% { rotate: 42deg }
  100% { rotate: 0deg }
}

.gear-b {
  left: 800px;
  top: 365px;
  height: 60px;
  rotate: 45deg;
}

.rotate-gear-b {
  animation-name: rotate-gear-b;
  animation-duration: 4s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes rotate-gear-b {
  0% { rotate: 45deg }
  100% { rotate: -30deg }
}

.rotate-gear-b-fail {
  animation-name: rotate-gear-b-fail;
  animation-duration: 3s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes rotate-gear-b-fail {
  0% { rotate: 45deg }
  90% { rotate: 7deg }
  100% { rotate: 45deg }
}

.weight {
  z-index: 20;
  position: absolute;
  font-family: Garamond, serif; 
  font-weight: bold;
  font-size: 30px;
  color: #303030;
}

#a {
  left: 594px;
  top: 550px;
}

#b {
  left: 844px;
  top: 550px;
}

#c {
  visibility: hidden;
  left: 194px;
  top: 365px;
  width: 50px;
  background-color: wheat;
  text-align: center;
}

.pot-a {
  left: 551px;
  top: 533px;
  width: 110px;
}

.pot-b {
  left: 801px;
  top: 533px;
  width: 110px;
}

.move-pot-ab {
  animation-name: move-pot-ab;
  animation-duration: 4s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-composition: add;
  animation-iteration-count: 1;
}

@keyframes move-pot-ab {
  100% { top: -83px; }
}

.move-pot-ab-fail {
  animation-name: move-pot-ab-fail;
  animation-duration: 3s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-composition: add;
  animation-iteration-count: 1;
}

@keyframes move-pot-ab-fail {
  0% { top: 0px; }
  90% { top: -42px; }
  100% { top: 0px; }
}

.pot-c {
  left: 145px;
  top: 339px;
  width: 145px;
}

.move-pot-c {
  animation-name: move-pot-c;
  animation-duration: 4s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes move-pot-c {
  100% { top: 500px; }
}

.move-pot-c-fail {
  animation-name: move-pot-c-fail;
  animation-duration: 3s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes move-pot-c-fail {
  0% { top: 339px; rotate: 0deg; }
  90% { top: 419px; rotate: 0deg; }
  97% { top: 500px; rotate: 0deg; }
  100% { top: 500px; rotate: 3deg;}
}

svg {
  position: absolute;
  z-index: 10;
  left: 0px;
  top: 0px;
  width: 1000px;
  height: 660px;
}

line {
  stroke: dimgrey;
  stroke-width: 5;
}

#rope-c {
  stroke-dasharray: 260;
  stroke-dashoffset: 160;
}

.extend-rope-c {
  animation-name: dash;
  animation-duration: 4s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes dash {
  0% { stroke-dashoffset: 160; }
  100% {  stroke-dashoffset: 0; }
}

.extend-rope-c-fail {
  animation-name: dash-fail;
  animation-duration: 3s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-iteration-count: 1;
}

@keyframes dash-fail {
  0% { stroke-dashoffset: 160; }
  90% {  stroke-dashoffset: 80; }
  100% { stroke-dashoffset: 200; }
}

.extend-rope-ab-fail {
  animation-name: extend-rope-ab-fail;
  animation-duration: 3s;
  animation-delay: 10ms;
  animation-timing-function: ease-in;
  animation-fill-mode: forwards;
  animation-composition: add;
  animation-iteration-count: 1;
  transform-origin: bottom;
}

@keyframes extend-rope-ab-fail {
  0% { scale: 100% 100%; }
  90% {  scale: 100% 100%; }
  100% { scale: 100% 40%; }
}
    </style>

    <script language="javascript">
      // TODO Crop water instead of positioning it at the bottom? Does it make cypress scroll?

      // TODO Change scene background and reveal so level 5 can use this one. Use Sand to reveal a door?
      // TODO roman numerals???
      // TODO: make them submit the form?

      // TODO hide all foreground elements until they are loaded, will look better

      function zoomAndNavigate(href) {
        const cropFrame = document.getElementById('cropFrame');
        cropFrame.classList.add('zoomBackground');

        setTimeout(() => window.location.assign(href), 2100);
      }
      
      function loaded() { 
        fillWater();
        setTimeout(showWeights, 4010);
      }
      
      function fillWater() {
        document.getElementById('waterLevel').classList.add('fill-water');
        setTimeout(() => document.getElementById('water').classList.add('slosh-water'), 4010);
      }

      function showWeights() {
        assignWeightsToPots();
        showC();
      }
      
      function showC() {
        document.querySelector('#c').style.visibility = 'visible';
      }

      let a = 0;
      let b = 0;
      let c = 999;

      function assignWeightsToPots() {
        a = Math.round(Math.random() * 89) + 10;
        b = Math.round(Math.random() * 89) + 10;
        spanA = document.querySelector('#a');
        spanB = document.querySelector('#b');
        spanA.textContent = a;
        spanB.textContent = b;
      }

      function checkAnswer(el) {
        const c = Number(el.value);
        const expectedAnswer = a + b;
        if (c == expectedAnswer) {
          correctAnswerSupplied();
        }
      }

      function correctAnswerSupplied() {
        if (isHuman()) {
          failToEmptyChamber();
        } else {
          emptyChamber();
        }
      }

      function failToEmptyChamber() {
        hideFields();
        startMovingGears('-fail');
        startMovingPots('-fail');
        startExtendingRopes('-fail');
        startDrainingWater('-fail');
        setTimeout(openDoor, 4200);
      }

      function emptyChamber() {
        hideFields();
        startMovingGears('');
        startMovingPots('');
        startExtendingRopes('');
        startDrainingWater('');
        setTimeout(openDoor, 4200);
      }

      function startExtendingRopes(classSuffix) {
        document.getElementById('rope-a').classList.add('extend-rope-ab' + classSuffix);
        document.getElementById('rope-b').classList.add('extend-rope-ab' + classSuffix);
        document.getElementById('rope-c').classList.add('extend-rope-c' + classSuffix);
      }

      function startMovingPots(classSuffix) {
        document.querySelector('.pot-a').classList.add('move-pot-ab' + classSuffix);
        document.querySelector('.pot-b').classList.add('move-pot-ab' + classSuffix);
        document.querySelector('.pot-c').classList.add('move-pot-c' + classSuffix);
      }

      function startMovingGears(classSuffix) {
        document.querySelector('.gear-a').classList.add('rotate-gear-a' + classSuffix);
        document.querySelector('.gear-b').classList.add('rotate-gear-b' + classSuffix);
        document.querySelector('.gear-c').classList.add('rotate-gear-c' + classSuffix);
        document.querySelector('.gear-ab').classList.add('rotate-gear-ab' + classSuffix);
        document.querySelector('.gear-abc').classList.add('rotate-gear-abc' + classSuffix);
      }

      function startDrainingWater(classSuffix) {
        document.getElementById('waterLevel').classList.add('drain-water' + classSuffix);        
      }

      function hideFields() {
        const a = document.querySelector('#a');
        const b = document.querySelector('#b');
        const c = document.querySelector('#c');
        a.style.visibility = 'hidden';
        b.style.visibility = 'hidden';
        c.style.visibility = 'hidden';
      }

      let hoverTempleCount = 0;
      function hoverTemple() {
        hoverTempleCount++;
      }

      function openDoor() {
        if (isHuman()) {
          window.alert('Right answer. But you tripped a boobytrap. Try using a robot.');
        } else {
          window.alert('Entering the room.');
          zoomAndNavigate('r4.html');
        }
      }

      function isHuman() {
        // TODO all pages - forget cypress, look at:
        // -  mouse position just before clicking?? Was it close? = human (also allows tester to move mouse over test browser while test is running and still be treated as a machine running it)
        // -  or just time taken to solve the puzzle? Was is slow? = human (handles mobile as well!)
        return hoverTempleCount > 3 || !isCypressRunning();
      }

      function isCypressRunning() {
        return window.Cypress;
      }

    </script>
  </head>

  <body onload="loaded();">

    <div class="image-container">
      <div id="cropFrame" class="image-container">

        <!-- TODO Rename background image file -->
        <img
          src="img/r3-background2.jpg"
          alt="Temple"
          onmousemove="hoverTemple();"
          class="fullImage backgroundImage"
        />

        <img
          src="img/r3-pot.png"
          alt="Large clay pot with a text field on it"
          class="layer1 pot-c"
        />

        <form
          action="">

        <input
          id='c'
          class='weight'
          type="text"
          size="3"
          required="true"
          placeholder="??"
          autofocus
          autocomplete="off"
          oninput="checkAnswer(this)"
        />

        </form>

        <img
          src="img/r3-gear.png"
          alt="gear for rope connecting to the large clay pot"
          class="layer3 gear-c"
        />

        <img
          src="img/r3-gear.png"
          alt="gear for rope connecting all pots"
          class="layer3 gear-abc"
        />

        <img
          src="img/r3-gear.png"
          alt="gear for rope connecting the two small pots"
          class="layer3 gear-ab"
        />
        
        <img
          src="img/r3-gear.png"
          alt="gear for rope connecting to a small pot"
          class="layer3 gear-a"
        />
        
        <img
          src="img/r3-gear.png"
          alt="gear for rope connecting to a small pot"
          class="layer3 gear-b"
        />

        <img
          src="img/r3-pot.png"
          alt="Small clay pot"
          class="layer3 pot-a"
        />

        <span
          id='a'
          class='weight'>
        </span>

        <img
          src="img/r3-pot.png"
          alt="Small clay pot"
          class="layer3 pot-b"
        />

        <span
          id='b'
          class='weight'>
        </span>

        <svg class="layer2"><line id="rope-c" x1="220" y1="260" x2="220" y2="520"/></svg>
        <svg class="layer2"><line id="rope-c-abc" x1="235" y1="236" x2="490" y2="135"/></svg>
        <svg class="layer2"><line id="rope-abc-ab" x1="512" y1="135" x2="740" y2="235"/></svg>
        <svg class="layer2"><line id="rope-ab-a" x1="747" y1="280" x2="620" y2="372"/></svg>
        <svg class="layer2"><line id="rope-ab-b" x1="756" y1="252" x2="851" y2="379"/></svg>
        <svg class="layer2"><line id="rope-a" x1="606" y1="390" x2="606" y2="549"/></svg>
        <svg class="layer2"><line id="rope-b" x1="857" y1="390" x2="857" y2="549"/></svg>

        <div id="waterLevel" class="layer4">
          <img
            id="water"
            src="img/r3-water.gif"
            alt="water filling the room"
          />
        </div>
      </div>
    </div>
  </body>
</html>
